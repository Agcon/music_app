<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{{ .Track.Title }} ‚Äî {{ .Track.Artist }}</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<header class="site-header">
  <div class="logo">
    <a href="/tracks">üéµ Music App</a>
  </div>
  {{if .IsAuthenticated}}
  <div class="user-info">
    <span>{{.Email}}</span>
    <form action="/logout" method="post" style="display:inline;">
      <button type="submit">–í—ã–π—Ç–∏</button>
    </form>
  </div>
  {{else}}
  <nav>
    <a href="/login">–í–æ–π—Ç–∏</a>
    <a href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
  </nav>
  {{end}}
</header>
<div class="container">
  <!-- 1) –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥ –∫–æ –≤—Å–µ–º —Ç—Ä–µ–∫–∞–º¬ª -->
  <div class="back-btn">
    <a href="/tracks">&larr; –í—Å–µ —Ç—Ä–µ–∫–∏</a>
  </div>

  <!-- 2) –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∞—Ä—Ç–∏—Å—Ç -->
  <h1>{{ .Track.Title }}</h1>
  <p class="artist">{{ .Track.Artist }}</p>

  <!-- 3) –ü–ª–µ–µ—Ä -->
  <div class="player">
    <audio id="audio" preload="metadata">
      <source src="/tracks/{{ .Track.ID.Hex }}/play" type="audio/mpeg">
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
    </audio>

    <!-- –ö–Ω–æ–ø–∫–∞ play/pause -->
    <button id="playPauseBtn" title="Play/Pause">‚ñ∂Ô∏è</button>

    <!-- –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è -->
    <span id="currentTime">0:00</span>

    <!-- –ü–æ–ª–∑—É–Ω–æ–∫ -->
    <input type="range" id="progressBar" value="0" min="0" step="1">

    <!-- –û–±—â–µ–µ –≤—Ä–µ–º—è -->
    <span id="duration">0:00</span>

    <!-- –†–µ–≥—É–ª—è—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ -->
    <input type="range" id="volume" min="0" max="1" step="0.01" value="1" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
  </div>
</div>

<script>
  const audio = document.getElementById('audio');
  const btn = document.getElementById('playPauseBtn');
  const bar = document.getElementById('progressBar');
  const cur = document.getElementById('currentTime');
  const dur = document.getElementById('duration');
  const vol = document.getElementById('volume');

  function fmt(time) {
    const m = Math.floor(time/60);
    const s = Math.floor(time%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  audio.addEventListener('loadedmetadata', () => {
    const durSeconds = audio.duration;

    if (isFinite(durSeconds) && durSeconds > 0) {
      bar.max = Math.floor(durSeconds);
      dur.textContent = fmt(durSeconds);
    } else {
      const checkReady = setInterval(() => {
        if (isFinite(audio.duration) && audio.duration > 0) {
          clearInterval(checkReady);
          bar.max = Math.floor(audio.duration);
          dur.textContent = fmt(audio.duration);
        }
      }, 500); // –∫–∞–∂–¥—ã–µ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º
    }
  });


  audio.addEventListener('timeupdate', () => {
    if (!isNaN(audio.currentTime) && bar.max > 0) {
      bar.value = Math.floor(audio.currentTime);
      cur.textContent = fmt(audio.currentTime);
    }
  });

  bar.addEventListener('input', () => {
    audio.currentTime = bar.value;
  });

  btn.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
      btn.textContent = '‚è∏Ô∏è';
    } else {
      audio.pause();
      btn.textContent = '‚ñ∂Ô∏è';
    }
  });

  vol.addEventListener('input', () => {
    audio.volume = vol.value;
  });
</script>
</body>
</html>
